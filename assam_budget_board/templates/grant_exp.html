{% load sekizai_tags static %}
{% addtoblock "css" %}
<link rel="stylesheet" type="text/css" href="{% static 'css/nv.d3.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/vis.css' %}">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
{% endaddtoblock %}
<div class="container">
        <div class="content-main-card col-lg-12">
            <h3 class="grant-summary-title">Grant Summary </h3>
            <div class="grant-summary-info">
                <i class="fas fa-info" data-toggle="modal" data-target="#exampleModal"></i>
            </div>
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            ...
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="summary summary-jumbotron">
                <div class="row">
                    <div class="col-lg-5 offset-lg-1">
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-5 offset-lg-1">
                        <h5 class="summary-indicator-title">{{ fiscal_year.be }}</h5>
                        <div class="big-figures" id="be-figures"></div>
                        <div class="summary_vis"></div>
                    </div>
                    <div class="col-lg-5 offset-lg-1">
                        <h5 class="summary-sec-indicator-title">{{ fiscal_year.be_prev }} </h5>
                        <div class=" secondary-big-figures" id="be_prev-figures"></div>
                        <h5 class="summary-sec-indicator-title">{{ fiscal_year.re }} </h5>
                        <div class=" secondary-big-figures" id="re-figures"></div>
                        <h5 class="summary-sec-indicator-title">{{ fiscal_year.actuals }} </h5>
                        <div class="secondary-big-figures" id="actuals-figures"></div>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <nav aria-label="breadcrumb" class="nav-breadcrumb col-lg-12">
                        <ol class="breadcrumb">
                        </ol>
                    </nav>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-md-3 side-col d-none d-md-block ">
                        <div class="side-navbar">
                            <div class="row">
                                <div class="side-navbar-head">
                                    <div class="back">
                                        <i class="fas fa-level-up-alt"></i>
                                    </div>
                                    <div class="side-navbar-title">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="side-navbar-list">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-lg-6 offset-lg-2">
                                <div class="select-dropdown"></div>
                            </div>
                        </div>
                        <div class="vis">
                            <svg></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div aria-label="Data Table Header" class="data-table-header col-lg-12">
                        Data Table
                    </div>
                </div>
                <div class="data-table-section" id='container-data'></div>
                    <!-- Data Table section goes here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% addtoblock "js" %}
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="{% static 'js/nv.d3.min.js' %}"></script>
<script src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
<script src="{% static 'js/makeTable.js' %}"></script>
<script type="text/javascript">
var actuals = "{{ fiscal_year.actuals }}",
    be_prev = "{{ fiscal_year.be_prev }}",
    re = "{{ fiscal_year.re }}",
    be = "{{ fiscal_year.be }}"

var currency_symbol = "&#8377;"

var currency_unit = "Lakhs"

var fig_list = [be, be_prev, re, actuals]

d3.csv(" {{ instance.url }} ", function(json) {
    var nested_data = d3.nest()
        .key(function(d) { return d["GRANT NUMBER"]; })
        .rollup(function(v) {
            return {
                act: d3.sum(v, function(d) { return +d[actuals]; }),
                be: d3.sum(v, function(d) { return +d[be]; }),
                be_prev: d3.sum(v, function(d) { return +d[be_prev]; }),
                re: d3.sum(v, function(d) { return +d[re]; })
            };
        })
        .entries(json);
    add_grant_summary(nested_data);
})

function indian_format(x) {
    var negative = x < 0,
        str = String(negative ? -x : x),
        arr = [],
        i = str.indexOf("."),
        j;

    if (i === -1) {
        i = str.length;
    } else {
        for (j = str.length - 1; j > i; j--) {
            arr.push(str[j]);
        }
        arr.push(".");
    }
    i--;

    for (j = 0; i >= 0; i--, j++) {
        if (j > 2 && (j % 2 === 1)) {
            arr.push(",");
        }
        arr.push(str[i]);
    }

    if (negative) {
        arr.push("-");
    }

    return arr.reverse().join("");
};

function add_grant_summary(data) {

    var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);

    var total_expenditure = {}
    total_expenditure["key"] = "Total Expenditure"
    total_expenditure["values"] = []
    var temp = {}
    temp["label"] = be
    temp["value"] = data[0].values.be
    temp["series"] = 0
    
    total_expenditure["values"].push(temp)
    temp = {}
    temp["label"] = be_prev
    temp["value"] = data[0].values.be_prev
    total_expenditure["values"].push(temp)

    d3.select("#be-figures").html(function(d) {
        var content = "<span class='absolute-figure'>" + currency_symbol + " " + indian_format(data[0].values.be.toFixed(2)) + " <span class='curreny-unit'>" + currency_unit + "</span> </span><br>"
        percentage_change = (((data[0].values.be - data[0].values.be_prev) / data[0].values.be_prev) * 100).toFixed(1)

        content += "<span class='percentage-figures'>"
        if (percentage_change > 0) {
            content += "<i class='fas fa-arrow-up positive-fig'></i> "
        } else {
            content += "<i class='fas fa-arrow-down negative-fig'></i> "
        }
        content += "<span class='percentage-num" + (percentage_change > 0 ? " positive-fig'" : " negative-fig'") + ">" + percentage_change + "%" + "</span></span>"
        return content
    })

    d3.select("#re-figures").html(currency_symbol + " " + indian_format(data[0].values.re.toFixed(2)) + " <span class='curreny-unit'>" + currency_unit + "</span> ")

    d3.select("#actuals-figures").html(currency_symbol + " " + indian_format(data[0].values.act.toFixed(2)) + " <span class='curreny-unit'>" + currency_unit + "</span> ")

    d3.select("#be_prev-figures").html(currency_symbol + " " + indian_format(data[0].values.be_prev.toFixed(2)) + " <span class='curreny-unit'>" + currency_unit + "</span> ")

    drawbarchart([total_expenditure], ".summary_vis");

    function drawbarchart(data, selection) {
        
        nv.addGraph(function() {

            chart = nv.models.multiBarHorizontalChart()
                .x(function(d) { return d.label })
                .y(function(d) { return +d.value })
                .barColor(["#183152", "#D0A825"])
                .duration(250)
                .margin({ left: 130, right: 75, top: 20, bottom: 30 })
                .stacked(false)
                .showControls(false)
                .showLegend(false);

            chart.height(130)
            chart.yAxis.ticks(5).tickFormat(function(d) {
                return formatAbbr(d)
            });

            if (w < 400) {
                chart.yAxis.ticks(2)
            }

            d3.select(selection).append("svg")
                .datum(data)
                .call(chart);
            nv.utils.windowResize(chart.update);

            return chart;
        });
    }
}
</script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script type="text/javascript">
var hierarchy = ["GRANT NUMBER", "Major Head", "Sub Major Head", "Minor Head", "Sub Head", "Sub Sub Head", "Detail Head", "Sub detail Head"]

var formatNumber = d3.format(".1f"),
    formatCrore = function(x) {
        return formatNumber(x / 1e7) + "Cr";
    },
    formatLakh = function(x) {
        return formatNumber(x / 1e5) + "L";
    },
    formatThousand = function(x) {
        return formatNumber(x / 1e3) + "k";
    },
    formatLowerDenom = function(x) {
        return x;
    };

function formatAbbr(x) {
    var v = Math.abs(x);
    return (v >= .9995e7 ? formatCrore : v >= .9995e5 ? formatLakh : v >= .999e3 ? formatThousand : formatLowerDenom)(x);
}

var max_tick_length = 35;

var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);

var margin = { top: 30, right: 40, bottom: 0, left: 170 },
    width = 460 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

if (w > 992) {
    var margin = { top: 30, right: 20, bottom: 0, left: 200 },
        width = 650 - margin.left - margin.right

} else if (w < 400) {
    var margin = { top: 30, right: 20, bottom: 0, left: 160 },
        width = w - margin.left - margin.right - 30
}

var x = d3.scale.linear()
    .range([0, width]);

var barHeight = 20;

var color = d3.scale.ordinal()
    .range(["#40627C", "#A7A37E"]);

var duration = 750,
    delay = 25;

var partition = d3.layout.partition()
    .value(function(d) { return d.size; });

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("top")
    .ticks(5)
    .tickFormat(function(d) { return formatAbbr(d); });;

if (w<450){
 xAxis.ticks(3)   
}
console.log(xAxis.ticks)
var svg = d3.select(".vis").select("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", function(d) {
        up(d);
        //remove_breadcrumb(this, d);
    })

var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([0, 10])
  .direction(function(d, i) {
    console.log(d, i)
    if(w < 450){ 
        return 'n'
    }
    return "e"
})
  .html(function(d) {
    //Change Value key to selected Fiscal figure
    return "<strong>Value</strong> : <span>" + d.value + "</span>";
  })

  svg.call(tip);

svg.append("g")
    .attr("class", "x axis");

svg.append("g")
    .attr("class", "y axis")
    .append("line")
    .attr("y1", "0%");

function populate_year_selection(data) {
    d3.select(".select-dropdown")
        .append("select")
        .attr("class", "form-control")
        .attr("id", "figure-select")
        .on("change", function() {
            var year = d3.select("#figure-select").property("value");
            draw_vis(data, year)
        })
        .selectAll("option")
        .data(fig_list)
        .enter()
        .append("option")
        .attr("class", "option-select")
        .text(function(d) {
            return d;
        })

}



function draw_vis(data, fiscal_year) {
    
    var nested_data = d3.nest()
        .key(function(d) { return d["GRANT NUMBER"]; })
        .key(function(d) { return d["Major Head"]; })
        .key(function(d) { return d["Sub-Major Head"]; })
        .key(function(d) { return d["Minor Head"]; })
        .key(function(d) { return d["Sub-Minor Head"]; })
        .key(function(d) { return d["Detailed Head"]; })
        .key(function(d) { return d["Object Head"]; })
        .key(function(d) { return d["Voucher Head"]; })
        .rollup(function(leaves) { return d3.sum(leaves, function(d) { return +d[fiscal_year]; }); })
        .entries(data);

    function renameStuff(d) {
        
        d.name = d.key;
        delete d.key;
        if (typeof d.values === "number") {
            d.size = d.values;
        } else {
            d.values.forEach(renameStuff), d.children = d.values;
        }
        delete d.values;
    }

    renameStuff(nested_data[0])

    var partition = d3.layout.partition()
        .value(function(d) {
            
            return parseInt(d.size);
        });

    d3.select(".nav-breadcrumb").select(".breadcrumb").html("")
    root = nested_data[0]
    partition.nodes(root);

    x.domain([0, root.value]).nice();
    down(root, 0);
}

function create_breadcrumb(e) {
    if (e.children) {
        d3.select(".nav-breadcrumb").select(".breadcrumb")
            .append("li")
            .attr("class", "breadcrumb-item")
            .attr("data-level", e.depth)
            .text(e.name)
            .style("cursor", "pointer")
            .on("click", function() {
                d3.select(".nav-breadcrumb").select(".breadcrumb")
                    .selectAll("li").filter(function() {
                        return this.getAttribute("data-level") >= e.depth
                    }).remove()
                down(e)
            })
    }
}

function create_list(d, i) {
    
    
    if (d.depth <= 0) {
        d3.select(".back").style("display", "none")
    } else {
        d3.select(".back").style("display", "inline-block")
            .on("click", function() { up(d) })
            .style("cursor", "pointer")

    }
    if (d.children) {
        d3.select(".side-navbar-list").selectAll("*").remove()

        d3.select(".side-navbar-title")
            .html(hierarchy[d.depth + 1]).style("opacity", 0).transition().delay(500).style("opacity", 1)

        

        var sidebar_list = d3.select(".side-navbar-list")
            .append("ul")
            .attr("class", "nav flex-column")


        var list_items = sidebar_list.selectAll("li")
            .data(d.children)
            .enter()
            .append("li")
            .attr("class", "nav-item")

        list_items.append("a")
            .attr("class", "nav-item")
            .html(function(d) {
                
                return d.name;
            })
            .on("click", function(d) {
                down(d)
                //create_list(d)
            })
            .style("cursor", function(d) {
                return !d.children ? null : "pointer";
            })

        d3.select(".side-navbar-list").style("opacity", 0).transition()
            .delay(550).style("opacity", 1)

    }
}

function down(d, i) {
    

    create_list(d, 0)
    create_breadcrumb(d)

    if (!d.children || this.__transition__) return;
    var end = duration + d.children.length * delay;

    // Mark any currently-displayed bars as exiting.
    var exit = svg.selectAll(".enter")
        .attr("class", "exit");

    // Entering nodes immediately obscure the clicked-on bar, so hide it.
    exit.selectAll("rect").filter(function(p) { return p === d; })
        .style("fill-opacity", 1e-6);

    // Enter the new bars for the clicked-on data.
    // Per above, entering bars are immediately visible.
    var enter = bar(d)
        .attr("transform", stack(i))
        .style("opacity", 1);

    // Have the text fade-in, even though the bars are visible.
    // Color the bars as parents; they will fade to children if appropriate.
    enter.select("text").style("fill-opacity", 1e-6);
    enter.select("rect").style("fill", color(true));

    // Update the x-scale domain.
    x.domain([0, d3.max(d.children, function(d) { return d.value; })]).nice();

    // Update the x-axis.
    svg.selectAll(".x.axis").transition()
        .duration(duration)
        .call(xAxis);

    // Transition entering bars to their new position.
    var enterTransition = enter.transition()
        .duration(duration)
        .delay(function(d, i) { return i * delay; })
        .attr("transform", function(d, i) { return "translate(0," + barHeight * i * 1.2 + ")"; });

    // Transition entering text.
    enterTransition.select("text")
        .style("fill-opacity", 1);

    // Transition entering rects to the new x-scale.
    enterTransition.select("rect")
        .attr("width", function(d) { return x(d.value); })
        .style("fill", function(d) { return color(!!d.children); });

    // Transition exiting bars to fade out.
    var exitTransition = exit.transition()
        .duration(duration)
        .style("opacity", 1e-6)
        .remove();

    // Transition exiting bars to the new x-scale.
    exitTransition.selectAll("rect")
        .attr("width", function(d) { return x(d.value); });

    // Rebind the current node to the background.
    svg.select(".background")
        .datum(d)
        .transition()
        .duration(end);

    d.index = i;
}

function up(d) {

    create_list(d.parent, 0)
    remove_breadcrumb(d)
    if (!d.parent || this.__transition__) return;
    var end = duration + d.children.length * delay;

    // Mark any currently-displayed bars as exiting.
    var exit = svg.selectAll(".enter")
        .attr("class", "exit");

    // Enter the new bars for the clicked-on data's parent.
    var enter = bar(d.parent)
        .attr("transform", function(d, i) { return "translate(0," + barHeight * i * 1.2 + ")"; })
        .style("opacity", 1e-6);

    // Color the bars as appropriate.
    // Exiting nodes will obscure the parent bar, so hide it.
    enter.select("rect")
        .style("fill", function(d) { return color(!!d.children); })
        .filter(function(p) { return p === d; })
        .style("fill-opacity", 1e-6);

    // Update the x-scale domain.
    x.domain([0, d3.max(d.parent.children, function(d) { return d.value; })]).nice();

    // Update the x-axis.
    svg.selectAll(".x.axis").transition()
        .duration(duration)
        .call(xAxis);

    // Transition entering bars to fade in over the full duration.
    var enterTransition = enter.transition()
        .duration(end)
        .style("opacity", 1);

    // Transition entering rects to the new x-scale.
    // When the entering parent rect is done, make it visible!
    enterTransition.select("rect")
        .attr("width", function(d) { return x(d.value); })
        .each("end", function(p) { if (p === d) d3.select(this).style("fill-opacity", null); });

    // Transition exiting bars to the parent's position.
    var exitTransition = exit.selectAll("g").transition()
        .duration(duration)
        .delay(function(d, i) { return i * delay; })
        .attr("transform", stack(d.index));

    // Transition exiting text to fade out.
    exitTransition.select("text")
        .style("fill-opacity", 1e-6);

    // Transition exiting rects to the new scale and fade to parent color.
    exitTransition.select("rect")
        .attr("width", function(d) { return x(d.value); })
        .style("fill", color(true));

    // Remove exiting nodes when the last child has finished transitioning.
    exit.transition()
        .duration(end)
        .remove();

    // Rebind the current parent to the background.
    svg.select(".background")
        .datum(d.parent)
        .transition()
        .duration(end);
}

function remove_breadcrumb(d) {
    
    if (d.parent) {
        d3.select(".nav-breadcrumb").select(".breadcrumb").select("li:last-child").transition()
            .delay(250).style("opacity", 0).remove();
    }
}

// Creates a set of bars for the given data node, at the specified index.
function bar(d) {
    
    d3.select(".y").select("line")
        .attr("y1", d.children.length * 24 + 5 + "px")

    if (d.children.length * 25 > 400) {
        d3.select(".vis").select("svg")
            .attr("height", d.children.length * 25)
    } else {
        d3.select(".vis").select("svg")
            .attr("height", 400)
    }
    var bar = svg.insert("g", ".y.axis")
        .attr("class", "enter")
        .attr("transform", "translate(0,5)")
        .selectAll("g")
        .data(d.children)
        .enter().append("g")
        //.attr("data-level",level_counter)
        .style("cursor", function(d) {
            return !d.children ? null : "pointer";
        })
        .on("click", function(d, i) {
            down(d, i)
            //add_card(d)
        });


    bar.append("text")
        .attr("x", -6)
        .attr("y", barHeight / 2)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .attr("width", "40px")
        .text(function(d) {
            
            if (d.name.length < max_tick_length) {
                return d.name;
            } else {
                return d.name.substring(0, max_tick_length - 3) + '...';
            }

        })
        .on("hover", function(d) {
            
        });

    bar.append("rect")
        .attr("width", function(d) {
            
            return x(d.value);

        })
        .attr("height", barHeight)
        .on('mouseover', tip.show)
      .on('mouseout', tip.hide);


    return bar;
}

// A stateful closure for stacking bars horizontally.
function stack(i) {
    var x0 = 0;
    return function(d) {
        var tx = "translate(" + x0 + "," + barHeight * i * 1.2 + ")";
        x0 += x(d.value);
        return tx;
    };
}

d3.csv(" {{ instance.url }} ", function(json) {
    data = json
    
    draw_vis(json, be)
    populate_year_selection(json);

})
</script>
<script type="text/javascript">
    // Data Table JS goes here
d3.csv("{{ instance.url }}", function(data){
var table_plot = makeTable()
  .datum(data);

d3.select('#container-data').call(table_plot);
  });
</script>

{% endaddtoblock %}
