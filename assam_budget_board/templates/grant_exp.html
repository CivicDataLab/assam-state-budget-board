{% load sekizai_tags  %}
{% addtoblock "css" %}
<style>

text {
  font: 10px sans-serif;
}

rect.background {
  fill: white;
}

.axis {
  shape-rendering: crispEdges;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
}

</style>
{% endaddtoblock  %}
<div class="row">
  <div class="col-lg-12">
  <div class="jumbotron jumbotron-fluid">
    <div class="container">
      <h1 class="display-4">Fluid jumbotron</h1>
      <p class="lead">This is a modified jumbotron that occupies the entire horizontal space of its parent.</p>
    </div>
  </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-9 offset-lg-3">
    <nav aria-label="breadcrumb" class="nav-breadcrumb">
      <ol class="breadcrumb">
      </ol>
    </nav>
  </div>
</div>
<div class="row">
	<div class="col-lg-3 side-col">
    <div class="side-navbar">
      <div class="side-navbar-title">
      </div>
      <div class="side-navbar-list">
      </div>
    </div>
  </div>
	<div class="col-lg-6">
		<div class="vis">
			<svg></svg>
		</div>
	</div>
</div>

{% addtoblock "js" %}  

<script src="https://d3js.org/d3.v4.min.js"></script> 
 
{#
<script type="text/javascript">
var hierarchy = ["GRANT NUMBER", "Major Head", "Sub Major Head",  "Minor Head" ,"Sub Head" , "Sub Sub Head",  "Detail Head", "Sub detail Head"]

var margin = {top: 30, right: 120, bottom: 0, left: 220},
    width = 760 - margin.left - margin.right,
    height = 900 - margin.top - margin.bottom;

var x = d3.scaleLinear()
    .range([0, width]);

var barHeight = 20;

var color = d3.scaleOrdinal()
    .range(["steelblue", "#ccc"]);

var duration = 750,
    delay = 25;

var partition = d3.partition();


var xAxis = d3.axisTop()
    .scale(x);

var svg = d3.select("div.vis svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", function(d){
        up(d);
        remove_breadcrumb(this,d);})

svg.append("g")
    .attr("class", "x axis");

svg.append("g")
    .attr("class", "y axis")
  .append("line")
    .attr("y1", "100%");

d3.csv(" {{ instance.url }} ", function(json) {
        data = json
        console.log(json)
        var nested_data = d3.nest()
        .key(function(d) { return d["GRANT NUMBER"]; })
        .key(function(d) { return d["Major Head"]; })
        .key(function(d) { return d["Sub-Major Head"]; })
        .key(function(d) { return d["Minor Head"]; })
        .key(function(d) { return d["Sub-Minor Head"]; })
        .key(function(d) { return d["Detailed Head"]; })
        .key(function(d) { return d["Object Head"]; })
        .key(function(d) { return d["Voucher Head"]; })
        .rollup(function(leaves) { return d3.sum(leaves, function(d) { return +d["2018-19 Budget Estimates"]; }); })
        .entries(data);
        d3.select("#text1").html(nested_data[0].key)
        console.log(nested_data)
        function renameStuff(d) {
		    d.name = d.key; delete d.key;
		    if (typeof d.value === "number"){
		    	d.size = d.value;
		 	}
		    else {
		    	d.values.forEach(renameStuff), d.children = d.values;
		    }
		    delete d.values;
		  }

		  renameStuff(nested_data[0])
		  
        var partition = d3.hierarchy(nested_data[0])
        //.value(function(d) {
        //    return parseInt(d["2018-19 Budget Estimates"]); });

        //partition(nested_data)

        root = d3.hierarchy(nested_data[0])
                .sum(d => d.size)
                .sort((a,b) => b.value - a.value);

		d3.partition(root);

		x.domain([0, root.value]).nice();
		down(root, 0);
		
    })

function create_breadcrumb(d){
  if(d.children){
    d3.select(".breadcrumb")
    .append("li")
    .attr("class", "breadcrumb-item")
    .text(d.data.name)
  }
}

function create_list(d, i){
	console.log(d.parent , d.children, d.depth)
	
  if(d.children){
  	d3.select(".side-navbar-list").html("")

    d3.select(".side-navbar-title")
    .html(hierarchy[d.depth])

    console.log(hierarchy[d.depth])

  	var sidebar_list = d3.select(".side-navbar-list")
  	.append("ul")
  	.attr("class","nav flex-column")
  	
  	var list_items = sidebar_list.selectAll("li")
  	.data(d.children)
  	.enter()
  	.append("li")
  	.attr("class","nav-item")

  	list_items.append("a")
  	.attr("class", "nav-item")
  	.html(function(d){
  		//console.log(d)
  		return d.data.name;
  	})
  	.on("click", function(d){
  		down(d)
  		//create_list(d)
  	})

  }
}

function down(d, i) {
	//console.log(i)

  create_list(d, 0)
  create_breadcrumb(d)

  if (!d.children || this.__transition__) return;
  var end = duration + d.children.length * delay;

  // Mark any currently-displayed bars as exiting.
  var exit = svg.selectAll(".enter")
      .attr("class", "exit");

  // Entering nodes immediately obscure the clicked-on bar, so hide it.
  exit.selectAll("rect").filter(function(p) { return p === d; })
      .style("fill-opacity", 1e-6);

  // Enter the new bars for the clicked-on data.
  // Per above, entering bars are immediately visible.
  var enter = bar(d)
      .attr("transform", stack(i))
      .style("opacity", 1);

  // Have the text fade-in, even though the bars are visible.
  // Color the bars as parents; they will fade to children if appropriate.
  enter.select("text").style("fill-opacity", 1e-6);
  enter.select("rect").style("fill", color(true));

  // Update the x-scale domain.
  x.domain([0, d3.max(d.children, function(d) { return d.value; })]).nice();

  // Update the x-axis.
  svg.selectAll(".x.axis").transition()
      .duration(duration)
      .call(xAxis);

  // Transition entering bars to their new position.
  var enterTransition = enter.transition()
      .duration(duration)
      .delay(function(d, i) { return i * delay; })
      .attr("transform", function(d, i) { return "translate(0," + barHeight * i * 1.2 + ")"; });

  // Transition entering text.
  enterTransition.select("text")
      .style("fill-opacity", 1);

  // Transition entering rects to the new x-scale.
  enterTransition.select("rect")
      .attr("width", function(d) { return x(d.value); })
      .style("fill", function(d) { return color(!!d.children); });

  // Transition exiting bars to fade out.
  var exitTransition = exit.transition()
      .duration(duration)
      .style("opacity", 1e-6)
      .remove();

  // Transition exiting bars to the new x-scale.
  exitTransition.selectAll("rect")
      .attr("width", function(d) { return x(d.value); });

  // Rebind the current node to the background.
  svg.select(".background")
      .datum(d)
    .transition()
      .duration(end);

  d.index = i;
}

function up(d) {

  create_list(d.parent, 0)
  //remove_breadcrumb()
  if (!d.parent || this.__transition__) return;
  var end = duration + d.children.length * delay;

  // Mark any currently-displayed bars as exiting.
  var exit = svg.selectAll(".enter")
      .attr("class", "exit");

  // Enter the new bars for the clicked-on data's parent.
  var enter = bar(d.parent)
      .attr("transform", function(d, i) { return "translate(0," + barHeight * i * 1.2 + ")"; })
      .style("opacity", 1e-6);

  // Color the bars as appropriate.
  // Exiting nodes will obscure the parent bar, so hide it.
  enter.select("rect")
      .style("fill", function(d) { return color(!!d.children); })
    .filter(function(p) { return p === d; })
      .style("fill-opacity", 1e-6);

  // Update the x-scale domain.
  x.domain([0, d3.max(d.parent.children, function(d) { return d.value; })]).nice();

  // Update the x-axis.
  svg.selectAll(".x.axis").transition()
      .duration(duration)
      .call(xAxis);

  // Transition entering bars to fade in over the full duration.
  var enterTransition = enter.transition()
      .duration(end)
      .style("opacity", 1);

  // Transition entering rects to the new x-scale.
  // When the entering parent rect is done, make it visible!
  enterTransition.select("rect")
      .attr("width", function(d) { return x(d.value); })
      .on("end",function(p) { if (p === d) d3.select(this).style("fill-opacity", null); });

  // Transition exiting bars to the parent's position.
  var exitTransition = exit.selectAll("g").transition()
      .duration(duration)
      .delay(function(d, i) { return i * delay; })
      .attr("transform", stack(d.index));

  // Transition exiting text to fade out.
  exitTransition.select("text")
      .style("fill-opacity", 1e-6);

  // Transition exiting rects to the new scale and fade to parent color.
  exitTransition.select("rect")
      .attr("width", function(d) { return x(d.value); })
      .style("fill", color(true));

  // Remove exiting nodes when the last child has finished transitioning.
  exit.transition()
      .duration(end)
      .remove();

  // Rebind the current parent to the background.
  svg.select(".background")
      .datum(d.parent)
      .transition()
      .duration(end);
}

function remove_breadcrumb(element, d){
     if (d.parent){
        d3.select(".breadcrumb").select("li:last-child").remove();    
     }
}

// Creates a set of bars for the given data node, at the specified index.
function bar(d) {
  var bar = svg.insert("g", ".y.axis")
      .attr("class", "enter")
      .attr("transform", "translate(0,5)")
      .selectAll("g")
      .data(d.children)
      .enter().append("g")
      .style("cursor", function(d) { return !d.children ? null : "pointer"; })
      .on("click", down);

  bar.append("text")
      .attr("x", -6)
      .attr("y", barHeight / 2)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d.data.name; });

  bar.append("rect")
      .attr("width", function(d) { return x(d.value); })
      .attr("height", barHeight);

  return bar;
}

// A stateful closure for stacking bars horizontally.
function stack(i) {
  var x0 = 0;
  return function(d) {
    var tx = "translate(" + x0 + "," + barHeight * i * 1.2 + ")";
    x0 += x(d.value);
    return tx;
  };
}

</script>


<script type="text/javascript">
/*
  hierarchy = ["GRANT NUMBER", "Major Head", "Minor Head"]
    actuals = "2016-17 Actuals"
    be_prev = "2017-18 Budget Estimates"
    re = "2017-18 Revised Estimates"
    be = "2018-19 Budget Estimates"


	d3.csv(" {{ instance.url }} ", function(json) {
	        /*data = json
	        console.log(json)
	        var nested_data = d3.nest()
	        .key(function(d) { return d["GRANT NUMBER"]; })
	        .key(function(d) { return d["Major Head"]; })
	        .key(function(d) { return d["Sub-Major Head"]; })
	        .key(function(d) { return d["Minor Head"]; })
	        .key(function(d) { return d["Sub-Minor Head"]; })
	        .key(function(d) { return d["Detailed Head"]; })
	        .key(function(d) { return d["Object Head"]; })
	        .key(function(d) { return d["Voucher Head"]; })
	        .rollup(function(leaves) { return d3.sum(leaves, function(d) { return +d["2018-19 Budget Estimates"]; }); })
	        .entries(data);
	        d3.select("#text1").html(nested_data[0].key)
	        console.log(nested_data)
	        function renameStuff(d) {
			    d.name = d.key; delete d.key;
			    if (typeof d.value === "number"){
			    	d.size = d.value;
			 	}
			    else {
			    	d.values.forEach(renameStuff), d.children = d.values;
			    }
			    delete d.values;
			  }

			  renameStuff(nested_data[0])
			  
	        var partition = d3.hierarchy(nested_data[0])
	        //.value(function(d) {
	        //    return parseInt(d["2018-19 Budget Estimates"]); });

	        //partition(nested_data)

	        root = d3.hierarchy(nested_data[0])
	                .sum(d => d.size)
	                .sort((a,b) => b.value - a.value);

			d3.partition(root);

			x.domain([0, root.value]).nice();
			down(root, 0);
			
		
	    console.log(json)
	    create_list(json, 0)

	    })

	function create_list(data, seq){

		console.log(data)

		hierarchy = ["GRANT NUMBER", "Major Head", "Minor Head"]
		actuals = "2016-17 Actuals"
		be_prev = "2017-18 Budget Estimates"
		re = "2017-18 Revised Estimates"
		be = "2018-19 Budget Estimates"

    var nested_2 = d3.nest()
    .key(function(d) { return d["GRANT NUMBER"]; })
    .key(function(d) { return d["Major Head"]; })
    .key(function(d) { return d["Sub-Major Head"]; })
    .key(function(d) { return d["Minor Head"]; })
    .key(function(d) { return d["Sub-Minor Head"]; })
    .key(function(d) { return d["Detailed Head"]; })
    .key(function(d) { return d["Object Head"]; })
    .key(function(d) { return d["Voucher Head"]; })
    .entries(data)

    console.log(nested_2)

		var nested = d3.nest()
		.key(function(d) { return d[hierarchy[seq]]; })
		.key(function(d) { return d[hierarchy[seq+1]]; })
		.rollup(function(v) { 
			return {
		    act: d3.sum(v, function(d) { return +d[actuals]; }),
		    be: d3.sum(v, function(d) { return +d[be]; }),
		    be_prev: d3.sum(v, function(d) { return +d[be_prev]; }),
		    re:d3.sum(v, function(d) { return +d[re]; })
		}; })
	    .entries(data);

	    //console.log(nested)


  generate_sidenavbar(nested_2[0], data);	 

	}

  function generate_sidenavbar(data, raw_data){
    console.log(data);

    data.rollup(function(v) { 
      return {
        act: d3.sum(v, function(d) { return +d[actuals]; }),
        be: d3.sum(v, function(d) { return +d[be]; }),
        be_prev: d3.sum(v, function(d) { return +d[be_prev]; }),
        re:d3.sum(v, function(d) { return +d[re]; })
    }; })

    d3.select(".side-navbar").html("")

    var sidebar_list = d3.select(".side-navbar")
    .append("ul")
    .attr("class","nav flex-column")
    
    var list_items = sidebar_list.selectAll("li")
    .data(data.values)
    .enter()
    .append("li")
    .attr("class","nav-item")

    list_items.append("a")
    .attr("class", "nav-item")
    .html(function(d){
      console.log(d.key)
      return d.key;
    })
    .on("click", function(d){
      down(d)
      //create_list(d)
    })

  }

*/
</script>

{% endaddtoblock %} 